<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>CVE-2010-2883 | V1NKe的心情垃圾桶</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="CVE," />
  

  <meta name="description" content="CVE-2010-2883">
<meta name="keywords" content="CVE-2010-2883">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-2883">
<meta property="og:url" content="http://yoursite.com/2018/10/06/CVE-2010-2883/index.html">
<meta property="og:site_name" content="V1NKe的心情垃圾桶">
<meta property="og:description" content="CVE-2010-2883">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/QQ20181003-231642@2x.png">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/QQ20181003-232041@2x.png">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/F2DAE82A-04DD-4123-B7D6-F567218E1D20.png">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/QQ20181003-234953@2x.png">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/QQ20181004-230857@2x.png">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/liucheng.png">
<meta property="og:image" content="http://yoursite.com/CVE-2010-2883/QQ20181006-142548@2x.png">
<meta property="og:updated_time" content="2018-10-06T06:43:55.944Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2010-2883">
<meta name="twitter:description" content="CVE-2010-2883">
<meta name="twitter:image" content="http://yoursite.com/CVE-2010-2883/QQ20181003-231642@2x.png">

  

  
    <link rel="icon" href="/haimian.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言："><span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#正文："><span class="toc-text">正文：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ROP-："><span class="toc-text">ROP ：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流程在栈中的执行情况："><span class="toc-text">流程在栈中的执行情况：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行到堆喷射后-："><span class="toc-text">执行到堆喷射后 ：</span></a></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-CVE-2010-2883" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">CVE-2010-2883</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2018.10.06</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>V1NKe</span>
        </span>
      

      


      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>研究的第一个cve，跟着漏洞战争这书来的，感觉第一个栈溢出就这么难。。而且发现这个cve的人脑洞为什么能这么大。。</p>
<h2 id="正文："><a href="#正文：" class="headerlink" title="正文："></a>正文：</h2><p>环境配置 ：</p>
<ol>
<li>Windows XP SP3</li>
<li>Ollydbg、PDFStreamDumper、IDA</li>
<li>软件：Adobe Reader 9.3.4</li>
</ol>
<p>漏洞点在SING表处，位于CoolType.dll文件处。</p>
<p>先将恶意pdf文件导入PDFStreamDumper，查看之后可以找到SING表的数据结构。</p>
<p><img src="/CVE-2010-2883/QQ20181003-231642@2x.png" alt="QQ20181003-231642@2x"></p>
<p>官方定义的SING的数据结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct&#123;</span><br><span class="line">    char   tag[4];</span><br><span class="line">    ULONG  checkSum;</span><br><span class="line">    ULONG  offset;</span><br><span class="line">    ULONG  length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据我们所找到的SING表的数据，可以知道偏移地址为0x11c。再往下找0x11c偏移处的内容：</p>
<p><img src="/CVE-2010-2883/QQ20181003-232041@2x.png" alt="QQ20181003-232041@2x"></p>
<p>但是在偏移0x10处的内容才是uniqueName域起始内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DCF9                 push    ebp</span><br><span class="line">.text:0803DCFA                 sub     esp, 104h           &lt;-----------栈长度0x104</span><br><span class="line">.text:0803DD00                 lea     ebp, [esp-4]</span><br><span class="line">.text:0803DD04                 mov     eax, ___security_cookie    &lt;---------Canary</span><br><span class="line">.text:0803DD09                 xor     eax, ebp</span><br><span class="line">.text:0803DD0B                 mov     [ebp+108h+var_4], eax</span><br><span class="line">.text:0803DD11                 push    4Ch</span><br><span class="line">.text:0803DD13                 mov     eax, offset sub_8184A54</span><br><span class="line">.text:0803DD18                 call    __EH_prolog3_catch</span><br><span class="line">.text:0803DD1D                 mov     eax, [ebp+108h+arg_C]</span><br><span class="line">.text:0803DD23                 mov     edi, [ebp+108h+arg_0]</span><br><span class="line">.text:0803DD29                 mov     ebx, [ebp+108h+arg_4]</span><br><span class="line">.text:0803DD2F                 mov     [ebp+108h+var_130], edi</span><br><span class="line">.text:0803DD32                 mov     [ebp+108h+var_138], eax</span><br><span class="line">.text:0803DD35                 call    sub_804172C</span><br><span class="line">.text:0803DD3A                 xor     esi, esi</span><br><span class="line">.text:0803DD3C                 cmp     dword ptr [edi+8], 3</span><br><span class="line">.text:0803DD40                 mov     [ebp+108h+var_10C], esi</span><br><span class="line">.text:0803DD43                 jz      loc_803DF00</span><br><span class="line">.text:0803DD49                 mov     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD4C                 mov     [ebp+108h+var_120], esi</span><br><span class="line">.text:0803DD4F                 cmp     dword ptr [edi+0Ch], 1</span><br><span class="line">.text:0803DD53                 mov     byte ptr [ebp+108h+var_10C], 1</span><br><span class="line">.text:0803DD57                 jnz     loc_803DEA9</span><br><span class="line">.text:0803DD5D                 push    offset aName    ; &quot;name&quot;</span><br><span class="line">.text:0803DD62                 push    edi             ; int</span><br><span class="line">.text:0803DD63                 lea     ecx, [ebp+108h+var_124]</span><br><span class="line">.text:0803DD66                 mov     [ebp+108h+var_119], 0</span><br><span class="line">.text:0803DD6A                 call    sub_80217D7</span><br><span class="line">.text:0803DD6F                 cmp     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD72                 jnz     short loc_803DDDD</span><br><span class="line">.text:0803DD74                 push    offset aSing    ; &quot;SING&quot;  &lt;------SING表入栈</span><br><span class="line">.text:0803DD79                 push    edi             ; int</span><br><span class="line">.text:0803DD7A                 lea     ecx, [ebp+108h+var_12C]   </span><br><span class="line">.text:0803DD7D                 call    sub_8021B06               &lt;------处理sing表</span><br><span class="line">.text:0803DD82                 mov     eax, [ebp+108h+var_12C]</span><br><span class="line">.text:0803DD85                 cmp     eax, esi</span><br><span class="line">.text:0803DD87                 mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">.text:0803DD8B                 jz      short loc_803DDC4</span><br><span class="line">.text:0803DD8D                 mov     ecx, [eax]</span><br><span class="line">.text:0803DD8F                 and     ecx, 0FFFFh</span><br><span class="line">.text:0803DD95                 jz      short loc_803DD9F</span><br><span class="line">.text:0803DD97                 cmp     ecx, 100h</span><br><span class="line">.text:0803DD9D                 jnz     short loc_803DDC0</span><br><span class="line">.text:0803DD9F</span><br><span class="line">.text:0803DD9F loc_803DD9F:                            ; CODE XREF: sub_803DCF9</span><br><span class="line">.text:0803DD9F                 add     eax, 10h                  &lt;-------uniqueName域</span><br><span class="line">.text:0803DDA2                 push    eax             ; char *</span><br><span class="line">.text:0803DDA3                 lea     eax, [ebp+108h+var_108]</span><br><span class="line">.text:0803DDA6                 push    eax             ; char *</span><br><span class="line">.text:0803DDA7                 mov     [ebp+108h+var_108], 0</span><br><span class="line">.text:0803DDAB                 call    strcat                    &lt;-------溢出！</span><br></pre></td></tr></table></figure>
<p>先来看看处理SING表的那一块函数地方。</p>
<p>先把字符串SING入栈，后入栈edi，调试可得：</p>
<p><img src="/CVE-2010-2883/F2DAE82A-04DD-4123-B7D6-F567218E1D20.png" alt="F2DAE82A-04DD-4123-B7D6-F567218E1D20"></p>
<p>暂且还不知道他的内容是怎么回事。继续看。</p>
<p>后来赋值了ecx。调用完函数之后eax中函数的返回值就是原ecx的值，来对比一下前后的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">调用前ecx：</span><br><span class="line">0012E4B4  74 F3 A8 04 28 6A 1C 02 00 00 00 00 00 00 00 00  t蟥(j........</span><br><span class="line">0012E4C4  CC B9 E7 00 70 E4 12 00 0C E7 12 00 54 4A 18 08  坦?p?..?.TJ</span><br><span class="line">0012E4D4  01 00 00 00 D8 E4 12 00 B0 E6 12 00 00 00 00 00  ...劁.版.....</span><br><span class="line">0012E4E4  E5 64 20 44 58 E8 12 00 9C AE 23 08 EF 52 08 08  錮 DX?.湲#颮</span><br><span class="line">0012E4F4  50 A6 23 08 BC 2D BB 04 0B 0D 08 08 6C F3 A8 04  P???.l蟥</span><br><span class="line">0012E504  D4 E4 12 00 50 E5 12 00 AF F8 11 01 FF FF FF FF  凿.P?.</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">调用后eax：</span><br><span class="line">0012E4B4  6C 0B A9 04 DF 1D 00 00 00 00 00 00 00 00 00 00  l??..........</span><br><span class="line">0012E4C4  CC B9 E7 00 70 E4 12 00 0C E7 12 00 54 4A 18 08  坦?p?..?.TJ</span><br><span class="line">0012E4D4  01 00 00 00 D8 E4 12 00 B0 E6 12 00 00 00 00 00  ...劁.版.....</span><br><span class="line">0012E4E4  E5 64 20 44 58 E8 12 00 9C AE 23 08 EF 52 08 08  錮 DX?.湲#颮</span><br><span class="line">0012E4F4  50 A6 23 08 BC 2D BB 04 0B 0D 08 08 6C F3 A8 04  P???.l蟥</span><br><span class="line">0012E504  D4 E4 12 00 50 E5 12 00 AF F8 11 01 FF FF FF FF  凿.P?.</span><br></pre></td></tr></table></figure>
<p>前八个字节发生了变化。在看后四字节0x1DDF。这不就是前面所看到的数据长度吗？所以我们可以推测出该函数大致上就是处理SING表内容的。再看看前四字节，调用完函数之后又重新赋值了一遍eax，刚好是把前四字节赋值给了eax。再看看后面对于eax的调用，又有一处加上了0x10，所以我们看看其地址处的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">d 0x4A90B6C :</span><br><span class="line">04A90B6C  00 00 01 00 01 0E 00 01 00 00 00 00 00 00 00 3A  ...........:</span><br><span class="line">04A90B7C  98 66 51 E6 AB 53 8B E7 14 A7 82 4A 0C 0C 0C 0C  榝Q娅S嬬J....</span><br><span class="line">04A90B8C  16 0A 12 37 7A 8C E7 36 3F DC A9 03 A1 E1 CF CB  .7z岀6?堠♂纤</span><br><span class="line">04A90B9C  7B 78 91 C5 8B 8C F7 5F 3D C8 2F 90 40 D3 35 1E  &#123;x懪媽鱛=?怈?</span><br><span class="line">04A90BAC  24 0B 45 5F 64 6D 61 0A 1D 5B 9E 6C 2E F6 6A EB  $E_dma.[瀕.鰆</span><br></pre></td></tr></table></figure>
<p>这不就是前面所看到的SING表内容吗，后面调用eax加上0x10的原因就在于加上0x10后的地址处内容才是uniqueName域的内容。</p>
<p>然后看edi的作用，edi寄存器所指的地址内容设置一下内存访问断点，查看一下被什么调用即可，经多次查看之后就可以发现edi偏移0x30处的0x4A8F374被下面图中处代码调用过。</p>
<p><img src="/CVE-2010-2883/QQ20181003-234953@2x.png" alt="QQ20181003-234953@2x"></p>
<p>在查看一下该处地址的对应内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d 0x4A8F374:</span><br><span class="line">04A8F374  00 01 00 00 00 11 01 00 00 04 00 10 4F 53 2F 32  .......OS/2</span><br><span class="line">04A8F384  B4 5F F4 63 00 00 EB 70 00 00 00 56 50 43 4C 54  確鬰..雙...VPCLT</span><br><span class="line">04A8F394  D1 8A 5E 97 00 00 EB C8 00 00 00 36 63 6D 61 70  褗^?.肴...6cmap</span><br><span class="line">04A8F3A4  A4 C3 E8 A0 00 00 B1 6C 00 00 03 58 63 76 74 20  っ锠..眑..Xcvt</span><br><span class="line">04A8F3B4  FF D3 1D 39 00 00 1E FC 00 00 01 FC 66 70 67 6D  ?9..?.黤pgm</span><br><span class="line">04A8F3C4  E7 B4 F1 C4 00 00 26 60 00 00 00 8B 67 61 73 70  绱衲..&amp;`...媑asp</span><br><span class="line">04A8F3D4  00 07 00 07 00 01 01 48 00 00 00 0C 67 6C 79 66  ...H....glyf</span><br><span class="line">04A8F3E4  0C 74 41 CF 00 00 26 EC 00 00 8A 7E 68 64 6D 78  .tA?.&amp;?.妦hdmx</span><br><span class="line">04A8F3F4  34 F0 21 0E 00 00 EC 00 00 00 15 48 68 65 61 64  4?..?..Hhead</span><br></pre></td></tr></table></figure>
<p>这是PDF文件中的字体对象。</p>
<p>所以说我们这里已经搞清楚了第一个call函数的用途：</p>
<p>函数通过传入表目录项的 TAG 名称，然后读取表目录项,处理后返回两个元素，第一个元素为表目录的内存映射地址，第二个元素为表目录的长度。</p>
<p>搞清了第一个函数之后再看看下一个漏洞点的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DD9F                 add     eax, 10h</span><br><span class="line">.text:0803DDA2                 push    eax             ; char *</span><br><span class="line">.text:0803DDA3                 lea     eax, [ebp+108h+var_108]</span><br><span class="line">.text:0803DDA6                 push    eax             ; char *</span><br><span class="line">.text:0803DDA7                 mov     [ebp+108h+var_108], 0</span><br><span class="line">.text:0803DDAB                 call    strcat</span><br></pre></td></tr></table></figure>
<p>用Ollydbg调试看看。</p>
<p><img src="/CVE-2010-2883/QQ20181004-230857@2x.png" alt="QQ20181004-230857@2x"></p>
<p>先是加上了0x10，即前文提到的uniqueName域，压入栈中，而后将ebp入栈，再调用strcat函数，所以说就是将uniqueName域拼接到ebp指向的地址。</p>
<p>因为并没有限制拼接的长度，所以就产生了溢出。</p>
<h3 id="ROP-："><a href="#ROP-：" class="headerlink" title="ROP ："></a>ROP ：</h3><p>接下来跟踪查看一下作者所构造的ROP链，是如何来利用这个溢出漏洞的。跟踪反复调试过之后可以得出，先执行到此处。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DDD2                 pop     ecx</span><br><span class="line">.text:0803DDD3</span><br><span class="line">.text:0803DDD3 loc_803DDD3:                            ; CODE XREF: sub_803DCF9+D1j</span><br><span class="line">.text:0803DDD3                 cmp     [ebp+108h+var_119], 0</span><br><span class="line">.text:0803DDD7                 jnz     loc_803DEA9             &lt;----------跳转实现</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">.text:0803DEA9 loc_803DEA9:                            ; CODE XREF: sub_803DCF9+5Ej</span><br><span class="line">.text:0803DEA9                                         ; sub_803DCF9+DEj ...</span><br><span class="line">.text:0803DEA9                 lea     eax, [ebp+108h+var_124]</span><br><span class="line">.text:0803DEAC                 push    eax</span><br><span class="line">.text:0803DEAD                 push    ebx</span><br><span class="line">.text:0803DEAE                 push    edi</span><br><span class="line">.text:0803DEAF                 call    sub_8016BDE</span><br></pre></td></tr></table></figure>
<p>进入sub_8016BDE函数中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.text:08016BDE                 push    ebp</span><br><span class="line">.text:08016BDF                 sub     esp, 660h</span><br><span class="line">.text:08016BE5                 lea     ebp, [esp-4]</span><br><span class="line">.text:08016BE9                 mov     eax, ___security_cookie</span><br><span class="line">.text:08016BEE                 xor     eax, ebp</span><br><span class="line">.text:08016BF0                 mov     [ebp+664h+var_4], eax</span><br><span class="line">.text:08016BF6                 push    50h</span><br><span class="line">.text:08016BF8                 mov     eax, offset sub_8175D32</span><br><span class="line">.text:08016BFD                 call    __EH_prolog3_catch</span><br><span class="line">.text:08016C02                 mov     eax, [ebp+664h+arg_8]</span><br><span class="line">.text:08016C08                 mov     esi, [ebp+664h+arg_4]</span><br><span class="line">.text:08016C0E                 mov     edi, [ebp+664h+arg_0]</span><br><span class="line">.text:08016C14                 mov     [ebp+664h+var_6BC], eax</span><br><span class="line">.text:08016C17                 mov     eax, offset CriticalSection</span><br><span class="line">.text:08016C1C                 push    eax             ; lpCriticalSection</span><br><span class="line">.text:08016C1D                 mov     [ebp+664h+var_680], esi</span><br><span class="line">.text:08016C20                 mov     [ebp+664h+var_6C0], eax</span><br><span class="line">.text:08016C23                 call    ds:EnterCriticalSection</span><br><span class="line">.text:08016C29                 xor     ebx, ebx</span><br><span class="line">.text:08016C2B                 push    edi</span><br><span class="line">.text:08016C2C                 mov     [ebp+664h+var_668], ebx</span><br><span class="line">.text:08016C2F                 mov     [ebp+664h+var_694], ebx</span><br><span class="line">.text:08016C32                 mov     [ebp+664h+var_678], ebx</span><br><span class="line">.text:08016C35                 call    sub_801BB1C</span><br><span class="line">.text:08016C3A                 cmp     eax, ebx</span><br><span class="line">.text:08016C3C                 pop     ecx</span><br><span class="line">.text:08016C3D                 mov     [ebp+664h+var_67C], eax</span><br><span class="line">.text:08016C40                 jz      loc_80172CE</span><br><span class="line">.text:08016C46                 push    1</span><br><span class="line">.text:08016C48                 push    ebx</span><br><span class="line">.text:08016C49                 push    ebx</span><br><span class="line">.text:08016C4A                 lea     eax, [ebp+664h+var_678]</span><br><span class="line">.text:08016C4D                 push    eax</span><br><span class="line">.text:08016C4E                 lea     eax, [ebp+664h+var_694]</span><br><span class="line">.text:08016C51                 push    eax</span><br><span class="line">.text:08016C52                 push    edi</span><br><span class="line">.text:08016C53                 push    [ebp+664h+var_67C]</span><br><span class="line">.text:08016C56                 call    sub_801BB21</span><br></pre></td></tr></table></figure>
<p>而后进入到sub_801BB21函数当中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:0801BB21                 push    ebp</span><br><span class="line">.text:0801BB22                 mov     ebp, esp</span><br><span class="line">.text:0801BB24                 push    [ebp+arg_18]</span><br><span class="line">.text:0801BB27                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:0801BB2A                 push    [ebp+arg_14]</span><br><span class="line">.text:0801BB2D                 mov     eax, [ecx]</span><br><span class="line">.text:0801BB2F                 push    [ebp+arg_10]</span><br><span class="line">.text:0801BB32                 inc     dword_823A6A0</span><br><span class="line">.text:0801BB38                 push    [ebp+arg_C]</span><br><span class="line">.text:0801BB3B                 push    [ebp+arg_8]</span><br><span class="line">.text:0801BB3E                 push    [ebp+arg_4]</span><br><span class="line">.text:0801BB41                 call    dword ptr [eax]</span><br></pre></td></tr></table></figure>
<p>再进入[eax]函数处，即0x808b116：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">.text:0808B116                 push    ebp</span><br><span class="line">.text:0808B117                 mov     ebp, esp</span><br><span class="line">.text:0808B119                 push    ecx</span><br><span class="line">.text:0808B11A                 push    ebx</span><br><span class="line">.text:0808B11B                 push    esi</span><br><span class="line">.text:0808B11C                 push    edi</span><br><span class="line">.text:0808B11D                 mov     edi, [ebp+arg_0]</span><br><span class="line">.text:0808B120                 push    edi</span><br><span class="line">.text:0808B121                 mov     esi, ecx</span><br><span class="line">.text:0808B123                 call    sub_808B02A</span><br><span class="line">.text:0808B128                 xor     ebx, ebx</span><br><span class="line">.text:0808B12A                 test    al, al</span><br><span class="line">.text:0808B12C                 jz      loc_808B2CB</span><br><span class="line">.text:0808B132                 cmp     [ebp+arg_14], bl</span><br><span class="line">.text:0808B135                 jnz     loc_808B2CB           &lt;--------跳转实现</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">.text:0808B2CB</span><br><span class="line">.text:0808B2CB loc_808B2CB:                            ; CODE XREF: sub_808B116+16j</span><br><span class="line">.text:0808B2CB                                         ; sub_808B116+1Fj</span><br><span class="line">.text:0808B2CB                 mov     eax, [esi]</span><br><span class="line">.text:0808B2CD                 mov     [ebp+arg_17], bl</span><br><span class="line">.text:0808B2D0                 call    dword ptr [eax+70h]</span><br><span class="line">.text:0808B2D3                 push    edi</span><br><span class="line">.text:0808B2D4                 lea     ecx, [esi+14h]</span><br><span class="line">.text:0808B2D7                 call    sub_801E540</span><br><span class="line">.text:0808B2DC                 mov     byte ptr [esi+0E0h], 1</span><br><span class="line">.text:0808B2E3                 mov     eax, [edi+3Ch]</span><br><span class="line">.text:0808B2E6                 cmp     eax, ebx</span><br><span class="line">.text:0808B2E8                 mov     [esi+2F4h], eax</span><br><span class="line">.text:0808B2EE                 mov     [esi+2F8h], ebx</span><br><span class="line">.text:0808B2F4                 mov     [ebp+var_4], ebx</span><br><span class="line">.text:0808B2F7                 jnz     short loc_808B300</span><br><span class="line">.text:0808B2F9</span><br><span class="line">.text:0808B2F9 loc_808B2F9:                            ; CODE XREF: sub_808B116+28Ej</span><br><span class="line">.text:0808B2F9                 xor     al, al</span><br><span class="line">.text:0808B2FB                 jmp     loc_808B594</span><br><span class="line">.text:0808B300 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0808B300</span><br><span class="line">.text:0808B300 loc_808B300:                            ; CODE XREF: sub_808B116+1E1j</span><br><span class="line">.text:0808B300                 lea     ecx, [ebp+var_4]</span><br><span class="line">.text:0808B303                 push    ecx</span><br><span class="line">.text:0808B304                 push    ebx</span><br><span class="line">.text:0808B305                 push    3</span><br><span class="line">.text:0808B307                 push    eax</span><br><span class="line">.text:0808B308                 call    dword ptr [eax]</span><br></pre></td></tr></table></figure>
<p>再进入[eax]处的存放地址，实际上是栈中存放的地址：</p>
<p>eax：0x0012E6D0，call地址：0x4A80CB38  返回到 icucnv36.4A80CB38 来自 icucnv36.4A846C49</p>
<p>而strcat拼接的地址是从0x0012E4D8开始的。</p>
<p>继续看接下来的调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4A80CB38    81C5 94070000   add ebp,0x794</span><br><span class="line">4A80CB3E    C9              leave</span><br><span class="line">4A80CB3F    C3              retn</span><br></pre></td></tr></table></figure>
<ol>
<li>第一条指令</li>
</ol>
<p>调用前：ebp –&gt; 0x0012DD48</p>
<p>调用后：ebp –&gt; 0x0012E4DC</p>
<ol start="2">
<li>第二条指令</li>
</ol>
<p>esp –&gt; 0x0012E4E0</p>
<p>ebp –&gt; 0xE78B53AB</p>
<ol start="3">
<li>第三条指令</li>
</ol>
<p>eip –&gt; 0x4A82A714  icucnv36.4A82A714</p>
<p>接下去的ROP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4A82A714    5C              pop esp                                  ; 0C0C0C0C</span><br><span class="line">4A82A715    C3              retn</span><br></pre></td></tr></table></figure>
<p>esp –&gt; 0x0c0c0c0c</p>
<p>接下去就是在堆内存0x0c0c0c0c处构造好的shellcode了。</p>
<p>这种在0x0c0c0c0c处构造shellcode的方法是堆喷射。</p>
<h3 id="流程在栈中的执行情况："><a href="#流程在栈中的执行情况：" class="headerlink" title="流程在栈中的执行情况："></a>流程在栈中的执行情况：</h3><p>我画了一个图，可以自行边调试边参考我画的在栈中执行的流程图。</p>
<p><img src="/CVE-2010-2883/liucheng.png" alt="liucheng"></p>
<p>可以看出来该跳转的稳定性主要来源于0x4A80CB38和0x4A82A714这两处地址，两处地址都位于icucnv26.dll的地址空间，而在Adobe的各个版本上，这个dll上的两处地址一直不变，所以该exploit在各个版本都很稳定。</p>
<h3 id="执行到堆喷射后-："><a href="#执行到堆喷射后-：" class="headerlink" title="执行到堆喷射后 ："></a>执行到堆喷射后 ：</h3><p>返回到0x0C0C0C0C后栈中的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0C0C0C0C   4A8063A5  icucnv36.4A8063A5</span><br><span class="line">0C0C0C10   4A8A0000  icucnv36.4A8A0000</span><br><span class="line">0C0C0C14   4A802196  icucnv36.4A802196</span><br><span class="line">0C0C0C18   4A801F90  icucnv36.4A801F90</span><br><span class="line">0C0C0C1C   4A84903C  &lt;&amp;KERNEL32.CreateFileA&gt;</span><br><span class="line">0C0C0C20   4A80B692  icucnv36.4A80B692</span><br><span class="line">0C0C0C24   4A801064  icucnv36.4A801064</span><br><span class="line">0C0C0C28   4A8522C8  icucnv36.4A8522C8</span><br><span class="line">0C0C0C2C   10000000  sqlite.10000000</span><br><span class="line">0C0C0C30   00000000</span><br></pre></td></tr></table></figure>
<p>先跳到0x4A8063A5处，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4A8063A5    59              pop ecx                                  ; icucnv36.4A8A0000</span><br><span class="line">4A8063A6    C3              retn</span><br></pre></td></tr></table></figure>
<p>而后转入0x4A802196,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4A802196    8901            mov dword ptr ds:[ecx],eax</span><br><span class="line">4A802198    C3              retn</span><br></pre></td></tr></table></figure>
<p>再转入0x4A801F90，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4A801F90    58              pop eax                               ; &lt;&amp;KERNEL32.CreateFileA&gt;</span><br><span class="line">4A801F91    C3              retn</span><br></pre></td></tr></table></figure>
<p>转入0x4A80B692，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4A80B692  - FF20            jmp dword ptr ds:[eax]                   ; kernel32.CreateFileA</span><br></pre></td></tr></table></figure>
<p>调用CreateFile函数，再查看栈中的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0C0C0C24   4A801064  /CALL 到 CreateFileA</span><br><span class="line">0C0C0C28   4A8522C8  |FileName = &quot;iso88591&quot;</span><br><span class="line">0C0C0C2C   10000000  |Access = GENERIC_ALL</span><br><span class="line">0C0C0C30   00000000  |ShareMode = 0</span><br><span class="line">0C0C0C34   00000000  |pSecurity = NULL</span><br><span class="line">0C0C0C38   00000002  |Mode = CREATE_ALWAYS</span><br><span class="line">0C0C0C3C   00000102  |Attributes = HIDDEN|TEMPORARY</span><br><span class="line">0C0C0C40   00000000  \hTemplateFile = NULL</span><br></pre></td></tr></table></figure>
<p>创建了一个名为“iso88591”的文件。</p>
<p>执行完该函数之后又用前面ROP调用CreateFileA相同的手法调用了CreateFileMapping函数，该函数创建了文件内存映射。此时调用的各个参数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0C0C0C68   4A801064  /CALL 到 CreateFileMappingA</span><br><span class="line">0C0C0C6C   0000043C  |hFile = 0000043C</span><br><span class="line">0C0C0C70   00000000  |pSecurity = NULL</span><br><span class="line">0C0C0C74   00000040  |Protection = PAGE_EXECUTE_READWRITE</span><br><span class="line">0C0C0C78   00000000  |MaximumSizeHigh = 0x0</span><br><span class="line">0C0C0C7C   00010000  |MaximumSizeLow = 0x10000</span><br><span class="line">0C0C0C80   00000000  \MapName = NULL</span><br></pre></td></tr></table></figure>
<p>后又执行，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4A80B692  - FF20            jmp dword ptr ds:[eax]                 ; kernel32.MapViewOfFile</span><br></pre></td></tr></table></figure>
<p>调用MapViewOfFile函数，各个参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0C0C0CA8   4A801064  /CALL 到 MapViewOfFile</span><br><span class="line">0C0C0CAC   00000440  |hMapObject = 00000440</span><br><span class="line">0C0C0CB0   00000022  |AccessMode = 0x22</span><br><span class="line">0C0C0CB4   00000000  |OffsetHigh = 0x0</span><br><span class="line">0C0C0CB8   00000000  |OffsetLow = 0x0</span><br><span class="line">0C0C0CBC   00010000  \MapSize = 10000 (65536.)</span><br></pre></td></tr></table></figure>
<p>后调用memcpy函数，各个参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0C0C0D44   04490000  /CALL 到 memcpy</span><br><span class="line">0C0C0D48   04490000  |dest = 04490000</span><br><span class="line">0C0C0D4C   0C0C0D54  |src = 0C0C0D54</span><br><span class="line">0C0C0D50   00001000  \n = 1000 (4096.)</span><br></pre></td></tr></table></figure>
<p>这里因为有着DEP的机制，所以说shellcode在堆栈上是无法执行的，因此这里就可以创建一个文件对象，然后映射到可读可写可执行的内存区域，再将shellcode拷贝到该区域，就可以执行shellcode了。而且恰好我们构造的ROP都处于icucnv36.dll，此处不受aslr保护，成功绕过aslr。</p>
<p><img src="/CVE-2010-2883/QQ20181006-142548@2x.png" alt="QQ20181006-142548@2x"></p>
<p>成功执行。</p>

    
  </div>

  
      <div class="git"></div>
  

</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持v1nke</div>
        <ul>
        
          <li class="item">
            <span>微信扫一扫</span>
            <img src="/images/qr-wechat.jpeg" alt="">
          </li>
        
          <li class="item">
            <span>支付宝扫一扫</span>
            <img src="/images/qr-wechat.jpeg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2018/09/28/arm_pwn/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2018/10/21/2018护网杯-pwn-writeup/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
